<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Elevation Profile with Draggable Markers</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #chart-container {
            height: 25%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10;
            background-color: rgba(255, 255, 255, 0.9);
            text-align: center;
        }
        #chart-inner-container {
            position: relative;
            margin: auto;
            height: 100%;
            width: 100vw;
        }
    </style>
</head>
<body>

<div id="map">
    <div id="chart-container">
        <div id="chart-inner-container">
            <canvas id="chart-canvas"></canvas>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoidGFza2FsbCIsImEiOiJjbTI0amdhNGkwZGtkMm1xd3BudHJ0dmN0In0.yK-2hu2fVVC6NwmdAXaAwQ';

    (async () => {
        const map = new mapboxgl.Map({
            container: 'map', // Container ID
            style: 'mapbox://styles/mapbox/outdoors-v12', // Style URL
            center: [23.80599, 38.048894], // Starting position [lng, lat]
            zoom: 13 // Starting zoom
        });

        // Define initial coordinates for the line
        const initialCoordinates = [
            [23.80599, 38.048894], // Start point
            [23.817323, 38.033029]  // End point
        ];

        // Create GeoJSON LineString
        let lineData = {
            type: 'Feature',
            geometry: {
                type: 'LineString',
                coordinates: initialCoordinates
            }
        };

        map.on('style.load', () => {
            // Add source and layer for the line
            map.addSource('line-data', {
                type: 'geojson',
                data: lineData
            });

            map.addLayer({
                id: 'line-line-data',
                type: 'line',
                source: 'line-data',
                paint: {
                    'line-width': 4,
                    'line-color': '#37a2eb'
                }
            });

            // Add digital elevation model tiles
            map.addSource('mapbox-dem', {
                type: 'raster-dem',
                url: 'mapbox://mapbox.mapbox-terrain-dem-v1',
                tileSize: 512,
                maxzoom: 20
            });
            map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1 });

            // Add draggable markers for start and end points
            const startMarker = new mapboxgl.Marker({ draggable: true, color: '#83f7a0' })
                .setLngLat(initialCoordinates[0])
                .addTo(map);

            const endMarker = new mapboxgl.Marker({ draggable: true, color: '#ed6461' })
                .setLngLat(initialCoordinates[1])
                .addTo(map);

            // Update line and elevation when markers are dragged
            startMarker.on('dragend', () => updateLineAndElevation(startMarker.getLngLat(), endMarker.getLngLat()));
            endMarker.on('dragend', () => updateLineAndElevation(startMarker.getLngLat(), endMarker.getLngLat()));
        });

        // Create the chart
        const myLineChart = new Chart(document.getElementById('chart-canvas'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Elevation (m)',
                    data: [],
                    fill: false,
                    borderColor: '#37a2eb',
                    tension: 0.4
                }]
            },
            options: {
                plugins: {
                    legend: { display: true },
                    title: { display: true, text: 'Elevation Profile' }
                },
                maintainAspectRatio: false,
                responsive: true,
                scales: {
                    x: {
                        grid: { display: false },
                        title: { display: true, text: 'Segments' }
                    },
                    y: {
                        title: { display: true, text: 'Elevation (m)' }
                    }
                },
                elements: {
                    point: { radius: 0 }
                }
            }
        });

        async function updateLineAndElevation(start, end) {
            // Update line coordinates
            lineData.geometry.coordinates = [
                [start.lng, start.lat],
                [end.lng, end.lat]
            ];
            map.getSource('line-data').setData(lineData);

            // Split the line into 1 km segments
            const chunks = turf.lineChunk(lineData, 1).features;

            // Get the elevation for the leading coordinate of each segment
            const elevations = await Promise.all(chunks.map((feature) => {
                return map.queryTerrainElevation(feature.geometry.coordinates[0]);
            }));

            // Add the last coordinate elevation
            const lastElevation = await map.queryTerrainElevation(chunks[chunks.length - 1].geometry.coordinates[1]);
            elevations.push(lastElevation);

            // Update chart with elevation data
            myLineChart.data.labels = Array.from({ length: elevations.length }, (_, i) => `Segment ${i + 1}`);
            myLineChart.data.datasets[0].data = elevations;
            myLineChart.update();
        }

        // Trigger the first chart draw after the DEM tiles have loaded
        await map.once('idle');
        updateLineAndElevation(startMarker.getLngLat(), endMarker.getLngLat());
    })();
</script>

</body>
</html>
