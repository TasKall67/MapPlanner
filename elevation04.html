<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elevation Chart</title>
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #chart-container { 
            height: 100vh; 
            width: 100%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        #chart-canvas { 
            width: 90%; 
            height: 60%; 
        }
    </style>
</head>
<body>

<div id="chart-container">
    <canvas id="chart-canvas"></canvas>
</div>

<script>
// Add the mapbox token for terrain query
mapboxgl.accessToken = 'pk.eyJ1IjoidGFza2FsbCIsImEiOiJjbTI0amdhNGkwZGtkMm1xd3BudHJ0dmN0In0.yK-2hu2fVVC6NwmdAXaAwQ';

// Initialize map in the background only for terrain queries
const map = new mapboxgl.Map({
    container: null, // Not displayed
    style: 'mapbox://styles/mapbox/outdoors-v12', // Required for queryTerrainElevation
    bounds: [-71.4, 44.36, -71.08, 44.25279] // Initial bounds (just for terrain query purposes)
});

// Once the map has loaded, start listening for messages
map.on('load', function () {
    // Listen for messages from Thunkable
    window.addEventListener('message', async function (event) {
        alert("Message received from Thunkable!");

        try {
            const { coordinates } = JSON.parse(event.data);  // Extract coordinates
            alert(`Received ${coordinates.length} coordinate pairs.`);

            // Query elevations for each coordinate
            const elevations = await getElevationsForCoordinates(coordinates);

            // If we have matching coordinates and elevations, update the chart
            if (coordinates.length === elevations.length) {
                updateChart(coordinates, elevations);
            } else {
                alert("Mismatch between coordinates and elevations.");
            }
        } catch (error) {
            alert("Error parsing message.");
            console.log("Error parsing incoming message:", error);
        }
    });
});

// Function to query elevations for given coordinates
async function getElevationsForCoordinates(coordinates) {
    const elevations = [];

    for (const coord of coordinates) {
        const elevation = await map.queryTerrainElevation(coord);  // Query elevation
        elevations.push(elevation !== null ? elevation : 0);  // Fallback to 0 if no data
    }

    return elevations;
}

// Function to update the chart
function updateChart(coordinates, elevations) {
    const ctx = document.getElementById('chart-canvas').getContext('2d');

    // Create a chart with coordinates as x-axis (or simple labels) and elevations as y-axis
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: coordinates.map((_, index) => `Point ${index + 1}`), // Optional: use coordinates or simple labels
            datasets: [{
                label: 'Elevation (m)',
                data: elevations,
                fill: false,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
            }]
        },
        options: {
            scales: {
                x: {
                    display: true
                },
                y: {
                    display: true,
                    beginAtZero: true
                }
            }
        }
    });
}
</script>

</body>
</html>
