<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Elevation Chart</title>
    <meta name="viewport" content="initial-scale=1.0, width=device-width">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.8.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.8.1/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-color: #f0f0f0;
        }
        #chart-container {
            width: 80%;
            height: 40%;
            margin: 20px;
        }
        canvas {
            width: 100% !important; 
            height: 100% !important;
        }
    </style>
</head>
<body>

<div id="chart-container">
    <canvas id="elevationChart"></canvas>
</div>

<script>
    // Initialize Chart.js
    const ctx = document.getElementById('elevationChart').getContext('2d');
    const elevationChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Elevation (m)',
                data: [],
                fill: false,
                borderColor: 'black',
                tension: 0.1
            }]
        },
        options: {
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Segment'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Elevation (m)'
                    }
                }
            }
        }
    });

    // Function to update the chart with elevation data
    function updateElevationChart(coordinates) {
        console.log("Coordinates received for elevation:", coordinates);

        // Clear previous chart data
        elevationChart.data.labels = [];
        elevationChart.data.datasets[0].data = [];

        const promises = coordinates.map((coord, index) => {
            return mapboxgl.accessToken
                ? fetch(`https://api.mapbox.com/terrain/v1/elevation?access_token=${mapboxgl.accessToken}&points=${coord[1]},${coord[0]}`)
                      .then(response => response.json())
                      .then(data => {
                          const elevation = data.elevations[0] ? data.elevations[0].elevation : 0;
                          elevationChart.data.labels.push(`Point ${index + 1}`);
                          elevationChart.data.datasets[0].data.push(elevation);
                      })
                      .catch(err => {
                          console.error("Error fetching elevation data:", err);
                      })
                : Promise.reject("Mapbox access token not set");
        });

        Promise.all(promises).then(() => {
            elevationChart.update();
        });
    }

    // Listen for messages from Thunkable
    window.addEventListener("message", function(event) {
        alert("Message received from Thunkable!"); // Confirm message received
        console.log("Raw message from Thunkable:", event.data);

        let message;
        try {
            message = JSON.parse(event.data);
        } catch (error) {
            console.error("Error parsing incoming message:", error);
            alert("Error parsing message.");
            return;
        }

        // Check if coordinates are received
        if (message.coordinates && Array.isArray(message.coordinates) && message.coordinates.length > 0) {
            alert("Received " + message.coordinates.length + " coordinate pairs.");
            console.log("Coordinates received:", message.coordinates);
            updateElevationChart(message.coordinates); // Call function to update chart
        } else {
            alert("No coordinates received.");
            console.log("No coordinates received.");
        }
    }, false);

    // Set your Mapbox access token here
    mapboxgl.accessToken = 'pk.eyJ1IjoidGFza2FsbCIsImEiOiJjbTI0amdhNGkwZGtkMm1xd3BudHJ0dmN0In0.yK-2hu2fVVC6NwmdAXaAwQ'; // Replace with your Mapbox access token
</script>
</body>
</html>
